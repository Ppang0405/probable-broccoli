name: E2E iOS

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  maestro-ios:
    name: Run Maestro on iOS
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      MAESTRO_VERSION: 1.39.0 # Pin a stable version
      JAVA_VERSION: '17'
      # GitHub Actions macOS-14/15 runners usually have iPhone 15 Pro
      SIMULATOR_NAME: iPhone 15 Pro 
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Dependencies
        run: npm ci

      - name: Install macOS dependencies
        run: |
          brew tap facebook/fb
          brew install facebook/fb/idb-companion

      - name: Install Maestro
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build iOS App for Simulator
        run: |
          # 1. Prebuild the project to generate ios folder
          npx expo prebuild --platform ios --clean
          
          # 2. Build using xcodebuild (easier to control output path than eas build --local in CI)
          # We need to find the workspace file
          WORKSPACE=$(find ios -name "*.xcworkspace" | head -n 1)
          SCHEME="PizzaApp" # Your app scheme (from app.json slug usually)
          
          echo "Building $SCHEME from $WORKSPACE..."
          
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            -quiet

      - name: Boot iOS Simulator
        run: |
          # Find the device UUID
          DEVICE_ID=$(xcrun simctl list devices available | grep "$SIMULATOR_NAME" | head -n 1 | awk -F "[()]" '{print $2}' | xargs)

          if [ -z "$DEVICE_ID" ]; then
            echo "No available simulator found for $SIMULATOR_NAME."
            xcrun simctl list devices available
            exit 1
          fi

          echo "Booting $SIMULATOR_NAME ($DEVICE_ID)..."
          xcrun simctl boot "$DEVICE_ID" || true

          # Wait for boot
          xcrun simctl bootstatus "$DEVICE_ID"

      - name: Install App on Simulator
        run: |
          # Find the built .app
          APP_PATH=$(find ios/build/Build/Products/Debug-iphonesimulator -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
             echo "Could not find .app file!"
             exit 1
          fi
          
          echo "Installing $APP_PATH..."
          xcrun simctl install booted "$APP_PATH"

      - name: Run Maestro Tests
        run: |
          # Ensure adb/idb is ready
          maestro test .maestro/flows -e MAESTRO_APP_ID=com.pizzaapp
