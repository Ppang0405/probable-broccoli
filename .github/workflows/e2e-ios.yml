name: E2E iOS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  maestro-ios:
    name: Run Maestro on iOS
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      MAESTRO_VERSION: 1.39.0 # Pin a stable version
      MAESTRO_DRIVER_STARTUP_TIMEOUT: 600000
      MAESTRO_CLI_NO_ANALYTICS: 1
      JAVA_VERSION: '17'
      # GitHub Actions macOS-14/15 runners usually have iPhone 16 Pro
      SIMULATOR_NAME: iPhone 16 Pro 
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Dependencies
        run: npm ci

      - name: Install macOS dependencies
        run: |
          brew tap facebook/fb
          brew install facebook/fb/idb-companion

      - name: Install Maestro
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash -s "${{ env.MAESTRO_VERSION }}"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build iOS App for Simulator
        run: |
          # 1. Prebuild the project to generate ios folder
          npx expo prebuild --platform ios --clean
          
          # 2. List ios directory for debugging
          ls -R ios | grep .xcworkspace || true
          
          # 3. Build using xcodebuild
          # Explicitly target the workspace and scheme
          xcodebuild \
            -workspace ios/PizzaApp.xcworkspace \
            -scheme PizzaApp \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath ios/build \
            ONLY_ACTIVE_ARCH=YES \
            -quiet

      - name: Boot iOS Simulator
        run: |
          # Find the device UUID
          DEVICE_ID=$(xcrun simctl list devices available | grep "$SIMULATOR_NAME" | head -n 1 | awk -F "[()]" '{print $2}' | xargs)

          if [ -z "$DEVICE_ID" ]; then
            echo "No available simulator found for $SIMULATOR_NAME."
            xcrun simctl list devices available
            exit 1
          fi

          echo "Booting $SIMULATOR_NAME ($DEVICE_ID)..."
          xcrun simctl boot "$DEVICE_ID" || true

          # Wait for simulator to be fully booted
          TIMEOUT=300
          START_TIME=$(date +%s)
          echo "Waiting for simulator to boot..."

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED_TIME=$((CURRENT_TIME - START_TIME))

            if [ $ELAPSED_TIME -ge $TIMEOUT ]; then
              echo "Timeout: simulator failed to boot for $TIMEOUT seconds."
              exit 1
            fi

            STATUS=$(xcrun simctl list | grep "$DEVICE_ID" | grep "(Booted)")

            if [[ -n "$STATUS" ]]; then
              echo "Simulator is booted!"
              break
            else
              echo "Still waiting for the simulator to boot ($ELAPSED_TIME seconds)..."
              sleep 10
            fi
          done

      - name: Install App on Simulator
        run: |
          # Find the built .app
          APP_PATH=$(find ios/build/Build/Products/Release-iphonesimulator -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
             echo "Could not find .app file!"
             # List the build directory to help debug
             find ios/build/Build/Products/Release-iphonesimulator -maxdepth 2
             exit 1
          fi
          
          echo "Installing $APP_PATH..."
          xcrun simctl install booted "$APP_PATH"

      - name: Run Maestro Tests
        run: |
          # Try running tests with retries as iOS drivers can be flaky in CI
          for i in 1 2 3; do
            echo "Maestro test attempt $i..."
            if maestro test .maestro/flows -e MAESTRO_APP_ID=com.pizzaapp --format junit --output report.xml; then
              echo "Tests passed!"
              exit 0
            else
              echo "Maestro tests failed on attempt $i"
              if [ $i -lt 3 ]; then
                echo "Retrying in 10 seconds..."
                sleep 10
              fi
            fi
          done
          echo "Maestro tests failed after 3 attempts"
          exit 1

      - name: Upload Maestro Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-report-ios
          path: report.xml

      - name: Upload Maestro debug output
        if: failure() || cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug-output-ios
          path: ~/.maestro/tests/**/*
          if-no-files-found: ignore
